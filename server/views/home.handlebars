<section class="tweets-section">
    <h2>Latest Tweets</h2>

    <div id="tweets-container"></div>
</section>

<style>
  .tweet {
    background: #fff;
    margin: 0.5rem 0;
    padding: 0.8rem;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,.1);
    opacity: 1;
    transform: translateY(0);
    transition: all 0.4s ease;
  }
  .tweet.new {
    opacity: 0;
    transform: translateY(-20px);
  }
  .tweet.new.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>

<script defer>
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("tweets-container");
    let oldestId = null;
    let lastId = null;
    const renderedIds = new Set();
    let isLoading = false;

    // Redner helper
    const renderTweet = (t) => `
      <div class="tweet new" data-id="${t._id}">
        <p><strong>${t.user}</strong>: ${t.text}</p>
        <small>${new Date(t.createdAt).toLocaleTimeString()}</small>
      </div>`;

    async function loadTweets(before = null, initial = false) {
      if(isLoading) return;
      isLoading = true;
      try {
        const url = before ? `/api/tweets?before=${before}` : `/api/tweets`;
        const res = await fetch(url);
        const tweets = await res.json();
        if(!tweets.length) return;

        const newTweets = tweets.filter((t) => !renderedIds.has(t._id));
        newTweets.forEach((t) => renderedIds.add(t._id));

        const html = newTweets.map(renderTweet).join("");
        if(initial) container.innerHTML = html;
        else container.insertAdjacentHTML("beforeend", html);

        // Animating newly added tweets
        requestAnimationFrame(() => {
          document
            .querySelectorAll(".tweet.new")
            .forEach((el) => el.classList.add("show"));
        });

        if(newTweets.length) {
          lastId = lastId || newTweets[0]._id;
          oldestId = newTweets[newTweets.length - 1]._id;
        }
      } catch(err) {
        console.error("Error loading tweets:", err);
      } finally {
        isLoading = false;
      }
    }

    async function checkForNewTweets() {
      try {
        if(!lastId) return;

        const res = await fetch(`/api/tweets?after=${lastId}`);
        const tweets = await res.json();

        if(!tweets.length) return scheduleNextCheck();

        const newTweets = tweets.filter((t) => !renderedIds.has(t._id));
        newTweets.forEach((t) => renderedIds.add(t._id));

        const html = newTweets.map(renderTweet).join("");
        if (newTweets.length) {
          container.insertAdjacentHTML("afterbegin", html);
          requestAnimationFrame(() =>
            document
              .querySelectorAll(".tweet.new")
              .forEach((el) => el.classList.add("show"))
          );
          console.info(
            `Fetched ${newTweets.length} new tweets at ${new Date().toLocaleTimeString()}`
          );
          lastId = newTweets[0]._id;
        }

        scheduleNextCheck();
      } catch(err) {
        console.error("Error checking for new tweets:", err);
      }
    }

    async function loadOlderTweets() {
      if(!oldestId || isLoading) return;
      console.log("Fetching older tweets...");
      await loadTweets(oldestId, false);
    }

    function scheduleNextCheck() {
      const delay = (5 + Math.random() * 20) * 1000;
      setTimeout(checkForNewTweets, delay);
    }

    window.addEventListener("scroll", async () => {
      if(
        !isLoading &&
        window.innerHeight + window.scrollY >= 
        document.body.offsetHeight - 200
      ) {
        await loadOlderTweets();
      }
    });

    loadTweets(null, true).then(scheduleNextCheck);
  });
</script>